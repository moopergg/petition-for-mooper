<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Petition</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    form {
      margin-bottom: 1rem;
    }
    input {
      padding: 0.5rem;
      font-size: 1rem;
      width: 70%;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 0.25rem 0;
    }
    #reset-btn {
      background: #f44336;
      color: white;
      border: none;
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Sign the Petition</h1>
  <form>
    <input placeholder="Your name" />
    <button type="submit">Sign</button>
  </form>

  <p><b>0</b> supporters so far:</p>
  <ul></ul>

  <button id="reset-btn">ðŸ”„ Reset Petition</button>

  <script>
    const el = {
      form: document.querySelector('form'),
      input: document.querySelector('input'),
      list: document.querySelector('ul'),
      count: document.querySelector('b'),
      resetBtn: document.getElementById('reset-btn')
    };

    function render(supporters) {
      el.list.innerHTML = '';
      el.count.textContent = supporters.length;
      for (const name of supporters) {
        const li = document.createElement('li');
        li.textContent = name;
        el.list.appendChild(li);
      }
    }

    async function loadSupporters() {
      try {
        const res = await fetch('/api/supporters');
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        render(Array.isArray(data.supporters) ? data.supporters : []);
      } catch (err) {
        console.error('Error loading supporters:', err);
      }
    }

    async function signPetition(event) {
      event.preventDefault();
      const name = el.input.value.trim();
      if (!name) return;

      try {
        const res = await fetch('/api/supporters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        if (!res.ok) throw new Error('Failed to sign');
        el.input.value = '';
        loadSupporters();
      } catch (err) {
        console.error('Error signing petition:', err);
      }
    }

    el.form.onsubmit = signPetition;
    loadSupporters();
    setInterval(loadSupporters, 10000); // refresh every 10 seconds

    el.resetBtn.onclick = async () => {
      if (!confirm('Are you sure you want to reset all signatures?')) return;
      try {
        const res = await fetch('/api/reset');
        if (!res.ok) throw new Error('Reset failed');
        loadSupporters();
        alert('Petition has been reset.');
      } catch (err) {
        console.error(err);
        alert('Error resetting petition.');
      }
    };

    // Show reset button only if ?admin=true is in the URL
    if (location.search.includes('admin=true')) {
      el.resetBtn.style.display = 'inline-block';
    }
  </script>
</body>
</html>
